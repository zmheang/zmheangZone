# 雅虎军规

### 目录

[TOC]

- ##### 内容部分

- ##### CSS部分

- ##### JS部分

- ##### JavaScript，CSS

- ##### 图片

- ##### cookie

- ##### 移动端

- ##### 服务器



#### 摘要：

​	无论是在工作中还是在面试中，web前端性能的优化都是很重要的，那么我们进行优化需要从哪些方面入手呢？可以遵循雅虎的前端优化35条军训



#### 内容部分

##### 1.  尽量减少HTTP请求数

​		80%的终端用户响应时间都花在了前端上，其中大部分事件都在下载页面中的各种组件：图片，样式表，脚本，Flash等等。减少组件数必然能够减少页面提交的HTTP请求数。这是让页面更快的关键

​		减少页面组件数的一种方式是简化页面设计。但有没有一种方法可以在构建复杂的页面同时加快响应事件呢？嗯，确实有鱼和熊掌兼得的办法

​		**合并文件**是通过把所有的脚本放在一个文件中的方式来减少请求数的，当然，也可以合并所有的CSS。如果页面的脚本和样式不一样的话，合并文件就是一项比较麻烦的工作了，但把这个作为站点发布过程的一部分确实可以提高响应事件

​		**CSS Sprites**是减少图片的请求数量的首选方式。把背景图片都整合到一张图中，然后用CSS的 background-image 和 background-position 属性来定位要显示的部分

​		**图像映射**可以把多张图片合并成单张图片，总大小是一样的，但减少了请求数并加速了页面的加载。图片映射只有在图像在页面中连续的时候才有用，比如导航条。给 image map 设置坐标的过程既无聊又容易出错，用 image map 来做导航也不容易，所以并不推荐这种方法

​		**行内图片(Base64编码)**用 data:URL 模式来把图片嵌入页面。这样会增加HTML文件的大小，把行内图片放在(缓存的)样式表中是个好办法，而且成功避免了页面变“重”。但目前主流浏览器并不能很好的支持行内图片

​		煎炒页面的HTTP请求数是个起点，这是提升站点首次访问速度的重要指导原则



##### 2.  减少DNS查找

​		域名系统建立了主机名和ip地址间的映射，就像电话簿上的人名和号码的映射一样。当你在浏览器输入 www.yahoo,com 的时候，浏览器就会联系 DNS 解析器返回服务器的 IP 地址。DNS 是有成本的，它需要20 ~ 120 ms去查找给定主机名的 IP 地址。在 DNS 查找完成之前，浏览器无法从主机名下载任何东西

​		DNS 查找被缓存起来更高效，由用户的 ISP 或者本地网络存在一个特殊的缓存服务器上，但还可以缓存在个人用户的计算机上。DNS 信息被保存在操作系统的 DNS cache里。大多数浏览器有独立于操作系统的自己的 cache。只要浏览器在自己的 cache 里还保留着这条记录，它就不会向操作系统查询 DNS 

​		如果客户端的DNS cache是空的， DNS 查找数等于页面上不同的主机名数， 包括页面 URL， 图片， 脚本文件， 样式表， Flash对象等等组件中的主机名，减少不同主机名就可以减少DNS 查找

​		减少不同主机名的数量同时也减少了页面能够并行下载的组件数量，避免DNS 查找削减了响应时间，而减少并行下载数量却增加了响应时间。我的原则是把组件分散在2 - 4个主机名下，这是同时减少DNS查找和允许高并发下载的折中方案



##### 3.  避免重定向

重定向用 301 和 302 状态码，下面是一个有 301 状态码的 HTTP 头：

```
HTTP/1.1 301 Moved Permanently
	Location: http://example.com/newuri
	Content-Type:text/html
```

​		浏览器会自动跳转到Location域指明的URL。重定向需要的所有信息都在 HTTP 头部，而响应体一般是空的。其实额外的 HTTP 头，比如Expires 和 Cache-Control也表示重定向。除此之外还有别的跳转方式： refresh 元标签和 JavaScript， 但如果你必须得做重定向，最好用标准得3XXHTTP 状态码，主要是为了让返回按钮能正常使用

​		牢记重定向会拖慢用户体验，在用户和 HTTP 文档之间插入重定向会延迟页面上得所有的东西，页面无法渲染，组件也无法开始下载，直到 HTML 文档被送达浏览器

​		有一种常见的极其浪费资源的重定向，而且web开发人员一般意识不到这一点，就是 URL 尾部缺少一个 斜线的时候。例如，跳转到 http://astrology.yahoo.com/astrology 会返回一个重定向到 http://astrology.yahoo.com/astrology/ 的301响应。在 Apache 中可以用Alias， mod_rewrite 或者 DirectorySlash 指令来取消不必要的重定向。

​		重定向最常见的用途是把旧站点连接到新的站点，还可以连接同一站点的不同部分，针对用户的不同情况（浏览器类型，用户账号类型等等）做一些处理。用重定向连接两个网站是最简单的，只需要少量的额外代码。虽然在这些时候使用重定向减少了开发人员的开发复杂度，但降低了用户体验。一种替代方案是用Alias 和 mod_rewrite ，前提是两个代码历经都在相同的服务器上。如果是因为域名变化未使用了重定向，就可以常见一条CNAME ，（创建一个指向另一个域名的DNS记录作为别名）结合A lias 或者 mod_rewrite 指令



##### 4.  让Ajax可缓存

​		Ajax的一个好处是可以给用户提供即时反馈，因为它能够从后台服务器异步请求信息。然而，用了 Ajax 就无法保证用户在等待异步 JavaScript 和 XML 响应返回期间不会非常无聊。在很多应用程序中，用户能够一直等待取决于如何使用 Ajax 。例如，在基于web的电子邮件客户端中，用户为了寻找符合他们搜索标准的邮件信息，将会保持对Ajax 请求返回结果的关注。重要的是，要记得“异步”并不意味着”即时“。

要提高性能，优化这些Ajax响应至关重要。最重要的提高Ajax性能的方法就是让响应变得可缓存，就像添上Expires 或者 Cache-Control HTTP头中讨论的一样，下面适用于Ajax的其他规则：

- ###### Gzip组件

- ###### 减少DNS查找

- ###### 压缩JavaScript

- ###### 避免重定向

- ###### 配置ETags

我们一起看看例子，一个Web 2.0 的电子邮件客户端用了 Ajax 拉i下载用户的通讯录，以便实现自动完成功能。如果用户从上次使用之后在没有修改过他的通讯录，而且Ajax响应是可缓存的，有尚未过期的Expires 或者 Cache-Control HTTP头，那么之前的通讯录就可以从缓存中读出。必须通知浏览器，应该继续使用之前缓存的通讯录响应还是去请求一个新的。可以通过给通讯录的Ajax URL里添加一个用户最后修改的时间戳来实现，例如&t=1190241612。 如果通讯录从上一次下载之后在没有被修改过，时间戳不变，通讯录就将从浏览器缓存中直接读出，从而避免一次额外的HTTP往返消耗



##### 5.  延迟加载组件

​		可以凑近看看页面并问自己：什么才是一开始渲染页面所必须的？其余的都可以等会儿。

​		JavaScript是分隔onload 事件之前和之后的一个理想选择。例如，如果有JavaScript代码和支持拖放以及动画的库，这些都可以先等会儿，因为拖放元素始在页面最初渲染之后的，其他可以延迟加载的部分包括隐藏内容（在某个交互动作之后才出现的内容）和折叠的图片



##### 6.  预加载组件

​		预加载可能看起来和延迟加载是相反的，但它其实有不同的目标。通过预加载组件可以充分利用浏览器空闲的时间来请求将会用到的组件（图片，样式和脚本）。用户访问下一页的时候，大部分组件已经在缓存里了，所以用户看来页面会加载的更快



##### 7.  减少DOM元素的数量

​		一个复杂的页面意味着要下载更多的字节，而且用JavaScript 访问DOM也会更慢。举个例子，想要添加一个事件处理器的时候，循环遍历页面上的500个DOM元素和5000个DOM元素是有区别的

​		在Firebug的控制台里输入：

```javascript
document.getElementsByTagName('*').length
```



##### 8.  跨域分离组件

​		分离组件可以最大化并行下载，但要确保只用不超过2 - 4个域，因为存在DNS查找的代价。



##### 9.  尽量少使用iframe

​		用iframe可以把一个HTML文档插入到父文档里，重要的是明白iframe是如何工作的并高效的使用它

​		iframe的优点：

- 引入缓慢的第三方内容，比如广告和标志

- 安全沙箱

- 并行下载脚本

  iframe的缺点：

- 代价高昂，即使是空白的iframe

- 阻塞页面加载

- 非语义



##### 10.  杜绝404

​		HTTP请求代价高昂，完全没有必要用一个HTTP请求去获取一个无用的响应，只会拖慢用户体验而没有任何好处



CSS部分

------

##### 11.  避免使用CSS表达式

​		用CSS表达式动态设置CSS属性，是一种强大又危险的方式。从IE5开始支持，但从IE8起就不推荐使用了。例如，可以用CSS表达式把背景颜色设置成按小时交替的：

```javascript
background-color: expression( (new Date()).getHours()%2 ? "#B8D4FF" : "#F08A00" );
```



##### 12.  选择 <link> 舍弃 @import

为了实现逐步渲染， CSS应该放在顶部，在IE中使用@import 与在底部用 <link>效果一样，所以最好不要使用



##### 13.  避免使用滤镜

​		IE专有的 AlphaImageLoader 滤镜可以用来修复 IE7之前的版本中半透明PNG图片的问题

​		最好的方法是干脆不用，而优雅的降级到IE中支持性很好的PNG8图片来代替



##### 14.  把样式表放在顶部



​	JS部分

------

##### 15.  去除重复的脚本

​		页面含有重复的脚本文件会影响性能，这可能和你想象的不一样。

​		IE会产生不必要的HTTP请求，而Firefox不会。在IE中，如果一个不可缓存的外部脚本被页面引用了两次，它会在页面加载时产生两个HTTP请求。即使脚本是可缓存的，在用户重新加载页面时也会产生额外的HTTP请求



##### 16.  尽量减少DOM访问

​		用JavaScript访问DOM元素是很慢的，所以为了让页面反应更迅速，应该：

- ###### 缓存已访问过的元素的索引

- ###### 先‘离线’更新节点，在把它们添到DOM树上

- ###### 避免使用JavaScript修复布局问题



##### 17.  用智能的事件处理器

​		有时候觉得页面反应不够灵敏，是因为又太多频繁执行的事件处理器被添加到了DOM树的不同元素上，这就是推荐使用事件委托的原因。如果一个 div 里面有10 个按钮，应该只给div 容器添加一个事件处理器，而不是给每个按钮都添加一个。时间能够冒泡，所以可以获取事件并得知哪个按钮是事件源



##### 18.  把脚本放在底部

​		脚本会阻塞并行下载，HTTP/1.1官方文档建议浏览器每个主机名下并行下载的组件描述不要超过2个，如果图片来自多个主机名，并行下载的数量可以超过2个。如果脚本正在下载，浏览器就不会开始任何其它下载任务，即使始在不同的主机名下的



##### 19.  把JavaScript 和 CSS放在外面

​		很多性能原则都是关于如何管理外部组件的，然而，在这些顾虑出现之前应该考虑一个更基础的问题：应该把JavaScript 和 CSS放在外部文件中还是直接写在页面里？

​		实际上，用外部文件可以让页面更快，因为JavaScript 和CSS文件会被缓存在浏览器。HTTP文档中的行内JavaScript 和 CSS在每次请求该HTML文档的时候都会被重新下载。这样做减少了所需的HTTP请求数，但增加了HTML文档的大小。另一方面，如果JavaScript 和 CSSS在外部文件中，并且已经被浏览器缓存起来了，那么我们就成功的把HTML文档变小了，而且没有增加HTTP请求数



##### 20.  压缩JavaScript 和 CSS

​		压缩具体来说就是从代码中取出不必要的字符以减少大小，从而提升加载速度。代码最小话就是去掉所有自己注释和不必要的空白字符（空格，换行和tab）。在JavaScript中这样做能够提高响应性能，因为要下载的文件变小了。两个最常用的JavaScript代码压缩工具是 JSMin 和 YUI Compressor



##### 21.  优化图片

​		尝试把 GIF图片转换成 PNG格式



##### 22.  优化CSS Sprite

- 在Sprite图片中横向排列一般都比纵向排列的最终文件小
- 组合Sprite图片中的相似颜色可以保持低色数，最理想的是256色以下PNG8格式
- ”对移动端友好“，不要在Sprite图片中留下太大的空隙



##### 23.  不要用Html缩放图片

​		不要因为在HTML中可以设置宽高而使用本不需要的大图



##### 24.  用小的可缓存的favicon.ico(收藏夹图标)

​		favicon.ico是放在服务器根目录的图片，应该确保：

- 足够小，最好在1K以下
- 设置合适的有效期HTTP头



##### 25.  给cookie减肥

​		使用cookie的原因很多，比如授权和个性化。HTTP头中的cookie信息在web服务器和浏览器之间交换。重要的是保证cookie尽可能的小，以最小化对用户响应时间的影响

- 清除不必要的cookie
- 保证cookie尽可能小，以最小化对用户响应时间的影响
- 注意给cookie设置合适的域级别，以免影响其他子域
- 设置合适的有效期，更早的有效期或者none可以更快的删除cookie，提高用户响应时间



##### 26.  把组件放在不含cookie的域下

​		当浏览器发送静态图像的请求时，cookie也会一起发送，而服务器根本不需要这些cookie。所以他们只会造成没有意义的网络通信量，应该确保对静态组件的请求不含cookie。可以创建一个子域，把所有的静态组件都部署在那儿



移动端

------

##### 27.  保证所有组件都小于25K

​		这个限制是因为iphone不能缓存大于25K的组件，注意这里指的时未压缩的大小



##### 28.  把组件打包到一个符合文档里

​		把各个组件打包成一个像有附件的电子邮件一样的符合文档里，可以用一个HTTP请求获取多个组件



服务器

------

##### 29.  Gzip组件

​		从HTTP/1.1开始，web客户端就有了支持压缩的Accept-Encoding HTTP请求头

```
Accept-Encoding: gzip, deflate
```

​		如果web服务器看到这个请求头，就会用客户端列出的一种方式来压缩响应。web服务器通过Content-Encoding响应头来通知客户端

```
Content-Encoding:gzip
```



##### 30.  避免图片src属性为空

​		会引起一个问题：浏览器会向服务器发送另一个请求



##### 31.  配置ETags

​		实体标签，是服务器和浏览器用来决定浏览器缓存中组件与源服务器中的组件是否匹配的一种机制



##### 32.  对Ajax用GET请求

​		

##### 33.  尽早清空缓冲区



##### 34.  使用CDN



##### 35.  添上Expires 或者 Cache-Control HTTP头